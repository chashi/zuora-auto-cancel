AWSTemplateFormatVersion: "2010-09-09"
Description: AWS Lambda - Handles auto-cancellations for membership and subscriptions

Parameters:
    App:
        Description: Application name
        Type: String
        Default: zuora-auto-cancel
    Stage:
        Description: Stage name
        Type: String
        AllowedValues:
            - PROD
            - UAT
        Default: UAT

Resources:
    zuora-auto-cancel-role:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    - Effect: Allow
                      Principal:
                          Service:
                             - lambda.amazonaws.com
                      Action:
                          - sts:AssumeRole
            Path: /
            Policies:
                - PolicyName: LambdaPolicy
                  PolicyDocument:
                      Statement:
                          - Effect: Allow
                            Action:
                                - logs:CreateLogGroup
                                - logs:CreateLogStream
                                - logs:PutLogEvents
                                - lambda:InvokeFunction
                            Resource: "*"

    zuora-auto-cancel-kms-key:
        Type: AWS::KMS::Key
            Properties:
              Description: !Sub Used by the ${App} lambda to encrypt and decrypt environment variables
              KeyPolicy:
                Version: '2012-10-17'
                Id: key-policy-zuora-auto-cancel
                Statement:
                - Sid: Enable IAM User Permissions
                  Effect: Allow
                  Principal:
                    AWS:
                      !Sub arn:aws:iam::${AWS::AccountId}:root
                  Action: kms:*
                  Resource: "*"
                - Sid: Allow access for Key Administrators
                  Effect: Allow
                  Action:
                  - kms:Create*
                  - kms:Describe*
                  - kms:Enable*
                  - kms:List*
                  - kms:Put*
                  - kms:Update*
                  - kms:Revoke*
                  - kms:Disable*
                  - kms:Get*
                  - kms:Delete*
                  - kms:ScheduleKeyDeletion
                  - kms:CancelKeyDeletion
                  Resource: "*"
                - Sid: Allow use of the key
                  Effect: Allow
                  Principal:
                    AWS:
                      Fn::GetAtt:
                      - zuora-auto-cancel-role
                      - Arn
                  Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                  Resource: "*"

    zuora-auto-cancel-lambda:
        Type: AWS::Lambda::Function
        Properties:
            Description: Handles auto-cancellations for membership and subscriptions
            FunctionName:
                !Sub ${App}-${Stage}
            Environment:
                Variables:
                  ZuoraRestUrl: ""
                  ZuoraUsername: ""
                  ZuoraPassword: ""
            Code:
                S3Bucket: zuora-auto-cancel-dist
                S3Key:
                    !Sub ${Stage}/${App}.zip
            Handler: com.gu.zuora-auto-cancel.Lambda::handleRequest
            Role:
                Fn::GetAtt:
                - zuora-auto-cancel-role
                - Arn
            KmsKeyArn:
                Fn::GetAtt:
                - zuora-auto-cancel-kms
                - Arn
            MemorySize: 512
            Runtime: java8
            Timeout: 300

# API Gateway config here



